<!DOCTYPE html>
<html>
<head>
    <title>Campus Secrets</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="title_logo">
  <img src="logo.png" alt="Website Logo">
</div>
    <nav><ul>
        <li><a href="#">Home</a></li><li><a href="#">Privacy</a></li><li><a href="#">Contact</a></li><li><a href="#">About</a></li>
    </ul></nav>

    <div id="std" class="zone-container">
        <h2>Students-Zone</h2>
        <input type="text" id="stdusername" placeholder="Choose a Username">
        <input type="password" id="stdpassword" placeholder="Choose a Password">
        <button type="button" id="stdsignuplogin">SignUp / Login</button>
        <div class="message" id="std-message"></div>
    </div>
    
    <div id="fac" class="zone-container">
        <h2>Faculty-Zone</h2>
        <p>(Logic not implemented yet)</p>
    </div>

    <script type="module">
    // Firebase SDK से ज़रूरी फंक्शन्स इम्पोर्ट करें
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // ======================================================
    // 1. FIREBASE CONFIGURATION
    // ======================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAvlhxYxEC61ZqIgSu0lq4wxMrXfi-ySCE",
        authDomain: "campussecrets-cc4b8.firebaseapp.com",
        projectId: "campussecrets-cc4b8",
        storageBucket: "campussecrets-cc4b8.appspot.com",
        messagingSenderId: "375125385371",
        appId: "1:375125385371:web:c6978d28896e25c86ce63e"
    };

    // Firebase को शुरू करें
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ======================================================
    // 2. HTML ELEMENTS
    // ======================================================
    const stdUserEl = document.getElementById('stdusername');
    const stdPassEl = document.getElementById('stdpassword');
    const stdBtn = document.getElementById('stdsignuplogin');
    const stdMsg = document.getElementById('std-message');

    // ======================================================
    // 3. EVENT LISTENER FOR THE BUTTON
    // ======================================================
    stdBtn.addEventListener('click', async () => {
        const username = stdUserEl.value.trim();
        const password = stdPassEl.value.trim();
        stdMsg.textContent = ''; 

        if (!username || !password) {
            stdMsg.className = 'message error';
            stdMsg.textContent = 'Please enter username and password.';
            return;
        }
        if (password.length < 6) {
            stdMsg.className = 'message error';
            stdMsg.textContent = 'Password must be at least 6 characters long.';
            return;
        }

        try {
            const dummyEmail = `${username}@campussecrets.me`;
            // **सुधार #1:** signInWithEmailAndPassword को सही तरीके से कॉल करें
            await signInWithEmailAndPassword(auth, dummyEmail, password);
            
            stdMsg.className = 'message success';
            stdMsg.textContent = `Welcome back, ${username}! Redirecting...`;
            window.location.href = 'studentszone.html';

        } catch (error) {
            if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/user-not-found') {
                handleSignUp(username, password);
            } else {
                console.error(error);
                stdMsg.className = 'message error';
                stdMsg.textContent = 'An unknown error occurred.';
            }
        }
    });

    // --- साइन-अप का फंक्शन ---
    async function handleSignUp(username, password) {
        stdMsg.textContent = 'Username not found. Trying to create a new account...';
        stdMsg.className = 'message';

        const usernameRef = doc(db, "usernames", username.toLowerCase());
        const usernameDoc = await getDoc(usernameRef);

        if (usernameDoc.exists()) {
            stdMsg.className = 'message error';
            stdMsg.textContent = 'This username is taken, and the password was incorrect.';
            return;
        }

        const dummyEmail = `${username}@campussecrets.me`;

        try {
            // **सुधार #2:** createUserWithEmailAndPassword को सही तरीके से कॉल करें
            const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
            await setDoc(usernameRef, { uid: userCredential.user.uid });

            stdMsg.className = 'message success';
            stdMsg.textContent = 'Account created! Please enter your details again to login.';

        } catch (authError) {
            console.error('Error creating user:', authError);
            stdMsg.className = 'message error';
            stdMsg.textContent = authError.message;
        }
    }
</script>
</body>
</html>